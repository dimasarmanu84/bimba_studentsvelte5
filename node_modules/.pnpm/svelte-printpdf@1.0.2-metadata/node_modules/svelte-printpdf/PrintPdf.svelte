<script>import { page } from '$app/stores';
import { pageClass } from './preferences';
export let print = false;
const appId = `SveltePrintPDF_${Math.floor(Math.random() * 999999999999)}`;
// 		storing display computed
let displays = [];
const selectorNotApp = `:not(#${appId}):not(#${appId} *):not(script):not(link)`;
// temporary element store when find element
let stackElements = [];
const findElementIsNotAppPdf = (el, selector, callback, _props = { i: 0 } // need reference object
) => {
    const recursive = (el, selector, callback, _props = { i: 0 }) => {
        el.querySelectorAll(selector).forEach((el) => {
            if (el.querySelector('#' + appId)) {
                recursive(el, selectorNotApp, callback, _props);
            }
            else {
                if (!stackElements.includes(el)) {
                    callback(el, _props.i++);
                    stackElements.push(el);
                }
            }
        });
    };
    recursive(el, selector, callback);
    // set to empty because is done
    stackElements = [];
};
const resolvePages = () => {
    const pages = document.getElementById(appId)?.querySelectorAll('.' + $pageClass);
    pages?.forEach((_page, i) => {
        let page = _page;
        // is first
        if (i === 0) {
            page.style.pageBreakBefore = 'auto';
        }
        else {
            page.style.pageBreakBefore = 'always';
        }
    });
};
$: if (print) {
    resolvePages();
    // Set to none all display element except AppPdf
    findElementIsNotAppPdf(document.body, `body > ${selectorNotApp}`, (el, i) => {
        displays[i] = window.getComputedStyle(el).display;
        el.style.display = 'none';
    });
    // 		print now
    window.print();
    // show them back
    findElementIsNotAppPdf(document.body, `body > ${selectorNotApp}`, (el, i) => {
        el.style.display = displays[i];
    });
    // reset display
    displays = [];
    print = false;
}
</script>

<span id={appId} class="__printpdf">
	<slot />
</span>

<style>
	.__printpdf {
		-webkit-print-color-adjust: exact !important;
		print-color-adjust: exact !important;
	}
	@media print {
		:global(table, img, svg, p) {
			page-break-inside: auto;
		}
	}
</style>
